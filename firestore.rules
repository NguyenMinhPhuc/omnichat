
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{userId} {
      // Allow anyone to read a specific user's config for the public chatbot to work.
      allow get: if true;
      // Allow admin users to list all users for the admin dashboard.
      allow list: if request.auth != null && isAdmin();
      // Only the user themselves can update their own data.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Chats can be created by anyone for the embedded bot.
    // Reading/updating chats should be restricted to the chatbot owner (admin/user).
    match /chats/{chatId} {
      allow create: if true;
      // Let's restrict read/update/delete to the owner of the chatbot for now.
      // This means only the user who owns the bot can see chat history in the dashboard.
      allow read, update, delete: if request.auth != null && request.auth.uid == resource.data.chatbotId;
    }
  }
}
