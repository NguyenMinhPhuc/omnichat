rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // User profile data.
    // Make user data publicly readable so the chatbot can fetch configuration.
    // Writes are restricted to the user themselves or an admin.
    match /users/{userId} {
      allow read; 
      allow write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Chat history for each session.
    // Allow anyone to create and update chat sessions. This is necessary for
    // the embedded, unauthenticated chatbot to function.
    match /chats/{chatId} {
      allow create, update; 
    }

    // Monthly usage statistics.
    // Only authenticated users can write to their own usage document.
    // Admins can read all usage documents for reporting.
    match /monthlyUsage/{usageId} {
      allow read: if request.auth != null && (request.resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
  }
}